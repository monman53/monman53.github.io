<!doctype html><html lang='ja'><head><meta charset='UTF-8'><meta name='viewport' content='width=device-width, initial-scale=1'><link rel='shortcut icon' type='image/png' href='/images/favicon.png'/><title>2次元高速フーリエ変換をWebGLでがんばる話 : monman53</title><script id='MathJax-script' async src='/scripts/mathjax/tex-chtml.js'></script><script type='text/x-mathjax-config'>MathJax.Hub.Config({tex2jax: {inlineMath: [['$','$']]}});</script><link rel='stylesheet' href='/styles/main.css'><script async src='https://www.googletagmanager.com/gtag/js?id=UA-111264044-1'></script><script src='/scripts/google.js'></script></head><body><header><div class='pad'><p class='bread'><a href='/'>monman53.github.io</a> / <a href='/post/'>post</a> / <a href='/post/2019/'>2019</a> / <a href='/post/2019/2dfft-iq1.html'>2dfft-iq1.html</a></p><p style='font-size: small;'>Last Modified : 2019-12-15 06:56:25 +0900</p></div></header><article><div class='pad'><h1>2次元高速フーリエ変換をWebGLでがんばる話</h1><div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>今年は「<a href="https://adventar.org/calendars/4115">IQ1 Advent Calendar 2019</a>」の1まいめにエントリーできました!</p>
</div>
<div class="paragraph">
<p>今回は2次元フーリエ変換(2DFFT)の話です．<br>
僕はYouTubeにある<a href="https://www.youtube.com/watch?v=qB0cffZpw-A">2次元逆フーリエ変換でアインシュタインが浮かび上がってくるデモ</a>が大好きです．<br>
いつか同じようなものを作ってみたいと思っていたので，この機会に実装しました．(めっちゃ楽しかった!)</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://monman53.github.io/demos/2dfft/index.html">2D Inverse Fourier Transform Playground</a> (CORSを使用しています．苦手な方はご注意を．)</p>
</li>
<li>
<p><a href="https://github.com/monman53/2dfft/">source code</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>どうせ作るなら皆に遊んでもらえて高速なものを! ということで，WebGLで高速フーリエ変換します．</p>
</div>
<div class="paragraph">
<p>以下，制作の補足を書いていきたいと思います．</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_2次元フーリエ変換">2次元フーリエ変換</h2>
<div class="sectionbody">
<div class="paragraph">
<p>次の2次元離散フーリエ変換・逆変換の式を用いました．</p>
</div>
<div class="stemblock">
<div class="content">
\[\begin{eqnarray}
F[u, v] &amp;=&amp; \frac{1}{N}\sum^{N-1}_{x=0}\sum^{N-1}_{y=0}f[x, y]e^{-j2\pi(yu+xv)/N},  \\
f[x, y] &amp;=&amp; \frac{1}{N}\sum^{N-1}_{u=0}\sum^{N-1}_{v=0}F[u, v]e^{j2\pi(vx+uy)/N}  \\
\end{eqnarray}\]
</div>
</div>
<div class="paragraph">
<p>2次元フーリエ変換は1次元フーリエ変換を縦方向と横方向に施すことで行うことが多いようです．<br>
今回は板ポリシェーダ芸で2DFFTを実現しようと思ったので，この式を少し変形したものを元に2DFFTについて考えてみます．</p>
</div>
<div class="paragraph">
<p>1次元の離散フーリエ変換・逆変換の式も一応載せておきます．</p>
</div>
<div class="stemblock">
<div class="content">
\[\begin{eqnarray}
F[u] &amp;=&amp; \frac{1}{\sqrt{N}}\sum^{N-1}_{x=0}f[x]e^{-j2\pi xu/N},  \\
f[x] &amp;=&amp; \frac{1}{\sqrt{N}}\sum^{N-1}_{u=0}F[u]e^{ j2\pi ux/N}
\end{eqnarray}\]
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_2次元高速フーリエ変換">2次元高速フーリエ変換</h2>
<div class="sectionbody">
<div class="paragraph">
<p>高速フーリエ変換では，奇数項と偶数項の2つに式を分けることでうまく動的計画法に持ち込みます．
2次元の場合は式を4つに分けられます．</p>
</div>
<div class="paragraph">
<p>これにより4つの部分問題に分けることができ，それぞれの計算結果が他の変換計算に共有される事実から計算量が削減されます．<br>
1次元高速フーリエ変換のバタフライ演算の図が有名ですが，2次元の場合はこんなかんじでしょうか．</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_実装">実装</h2>
<div class="sectionbody">
<div class="paragraph">
<p>バタフライ演算の1ステップをテクスチャレンダリングで実現します．<br>
2枚のテクスチャを交互に使って計算していきます．<br>
例えば256x256の画像であれば8ステップのレンダリングで計算が終了します．</p>
</div>
<div class="paragraph">
<p>FFTの計算以外にもUI用のCanvasをいくつか設置し，
それぞれをつなぐテクスチャのパイプラインシステムを作るわけなのですが，
WebGLでは複数のRenderer間でテクスチャを共有できない
<sup class="footnote">[<a id="_footnoteref_1" class="footnote" href="#_footnotedef_1" title="View footnote.">1</a>]</sup>
ので，Renderer一本でがんばる必要がありました．</p>
</div>
<div class="paragraph">
<p>あと，デフォルトでテクスチャのサンプリング方式がLinnerだったので計算が破綻しました．<br>
Nearestに変更する必要があります．(いまいちこのあたりよく分かっていない．)</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_おわりに">おわりに</h2>
<div class="sectionbody">
<div class="paragraph">
<p>修論とは&#8230;&#8203;</p>
</div>
<div class="paragraph">
<p>明日はcrskさんが何か添えてくれるみたいですね!</p>
</div>
<div class="paragraph">
<p><a href="https://adventar.org/calendars/4115">IQ1 Advent Calendar 2019</a></p>
</div>
</div>
</div><hr><h4>脚注</h4><p id='_footnote_1'><small>1. Allow access to the same WebGLRenderer texture across multiple WebGLRenderer instances <a href="https://github.com/mrdoob/three.js/issues/13745" class="bare">https://github.com/mrdoob/three.js/issues/13745</a></small></p></div></article><footer><div class='pad'><p>Last Modified : 2019-12-15 06:56:25 +0900</p><p><a href='/'>monman53.github.io</a></p><p>This page is generated by <a href='https://github.com/monman53/monsta'>monsta</a>.</p><p><a rel='license' href='http://creativecommons.org/licenses/by/4.0/'><img alt='Creative Commons License' style='border-width:0' src='/images/cc-by.png' height='30px'/></a><br>This work is licensed under a <a rel='license' href='http://creativecommons.org/licenses/by/4.0/'>Creative Commons Attribution 4.0 International License</a>.</p></div></footer></body></html>
